dist: xenial
language: bash
services:
  - docker

env:
  global:
    DOCKER_COMPOSE_VERSION: 1.23.2
    # DOCKER_BUILD_STAGES: >-
    #   "ext-builder
    #   ext-inotify
    #   ext-pcntl
    #   ext-xdebug
    #   ext-swoole
    #   app-installer
    #   base
    #   base-with-xdebug
    #   base-cli
    #   base-server
    #   base-coverage
    #   base-server-coverage
    #   cli
    #   composer
    #   composer-coverage
    #   server
    #   server-coverage"
    PHP_VERSION: 7.2
    ALPINE_VERSION: 3.8
    SWOOLE_VERSION: 4.2.13
    COMPOSER_ARGS: install

# matrix:
#   allow_failures:
#     - php: "7.3"
#   include:
#     - php: "7.2"
#       before_script:
#         - >-
#           curl -L
#           https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64
#           > ./cc-test-reporter
#         - chmod +x ./cc-test-reporter
#         - ./cc-test-reporter before-build
#       after_success:
#         - composer merge-code-coverage
#         - ./cc-test-reporter after-build -t clover --exit-code $TRAVIS_TEST_RESULT
#       env:
#         - COVERAGE=1
#         - DEPLOY=1

before_install:
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
  - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
  - sudo apt-get update
  - sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-ce
  - docker --version
  - sudo rm /usr/local/bin/docker-compose
  - curl -L "https://github.com/docker/compose/releases/download/$DOCKER_COMPOSE_VERSION/docker-compose-$(uname -s)-$(uname -m)" > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin
  - docker-compose --version

script:
  # - export CURRENT_BUILD_METADATA="php-$PHP_VERSION-swoole-$SWOOLE_VERSION"
  - export PUBLISH_BUILD_METADATA="php-$PHP_VERSION"
  - export CACHE_METADATA="$PUBLISH_BUILD_METADATA"
  - export BUILD_METADATA="$PUBLISH_BUILD_METADATA"

  - docker-compose pull --ignore-pull-failures
  - docker-compose build
  - docker-compose run --no-deps composer cs-analyse
  - docker-compose run --no-deps composer static-analyse-src
  - docker-compose run --no-deps composer static-analyse-tests
  - docker-compose run --no-deps composer phpunit
  - docker-compose run --no-deps server

after_success:
  - |
    if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then
      echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USER" --password-stdin;
      docker-compose push --ignore-push-failures;
    fi

# before_deploy:
#   - >-
#     export VERSION=$(git tag -l | sort -V -r | head -1 | sed -E 's/v(.*)/\1/') && echo "VERSION=${VERSION}"
#   - yarn global add conventional-changelog-cli conventional-recommended-bump conventional-github-releaser

# deploy:
#   - provider: script
#     skip_cleanup: true
#     script: bash ./deploy/releaser.sh
#     on:
#       branch: master
#       condition: $DEPLOY = 1
